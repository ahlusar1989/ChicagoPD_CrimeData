<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>

  <title>Experiment</title>

  <script charset="utf-8" src="http://d3js.org/d3.v3.min.js"></script>
  <script src='./javascripts/crossfilter.js' type='text/javascript'></script>
  <script src='http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.js' type='text/javascript'></script>
  <script src='./javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='./javascripts/bootstrap.min.js' type='text/javascript'></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <link href='./stylesheets/bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.css' rel='stylesheet' type='text/css'>
    <!-- Bootstrap Core CSS -->
  <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- MetisMenu CSS -->
  <link href="./bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link href="./bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">

  <!-- DataTables Responsive CSS -->
  <link href="./bower_components/datatables-responsive/css/responsive.dataTables.scss" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="./stylesheets/admin.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="./bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">

  
  <style>

    .axis path,

    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .bar:hover {
      fill: orangered ;
    }

    .x.axis path {
      display: none;
    }

    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }



    #dc-magnitude-chart .x.axis text {
    text-anchor: end !important;
    transform: rotate(-35deg);
    font-size: 8px;
    }


    h4 span {
      font-size:14px;
      font-weight:normal;
      }
    h2 {
      float: right;
    }
    h2 span {
      font-size:14px;
      font-weight:normal;
      }


  </style>
</head>

<body>

    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Morris Charts JavaScript -->
     <script src="./bower_components/raphael/raphael-min.js"></script>
     <script src="./bower_components/morrisjs/morris.min.js"></script>
     <script src="./javascripts/morris-data.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="./javascripts/sb-admin-2.js"></script>



          <div class='container' style='font: 12px "Gill Sans", Impact, sans-serif;'>
            <div class="dc-data-count" style="float: left;">
              <h2>
              Chicago City Crime Stats (01/01/2015 -12/23/2015)
                <span>
                  <span class="filter-count"></span>
                   selected out of 
                  <span class="total-count"></span>
                   records | 
                  <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
                </span>
              </h2>
            </div>
              
            <div class='row'>
              <div class='span6' id='dc-magnitude-chart'>
                <h4>
          		Arrests over the span of 12 month
                  <span>
                    <a class="reset"
                      href="javascript:magnitudeChart.filterAll();dc.redrawAll();"
                      style="display: none;">
                      reset
                    </a>
                  </span>
          	  </h4>
              </div>
              <div class='span6' id='dc-depth-chart'>
          	  <h4>
          		What wards received the most number of incidents?
                  <span>
                    <a class="reset"
                      href="javascript:depthChart.filterAll();dc.redrawAll();"
                      style="display: none;">
                      reset
                    </a>
                  </span>
                </h4>
              </div>   
            </div>

            <div class='row'>
              <div class='span12' id='dc-time-chart'>
                <h4>
          		What was the frequency of stops (number of records per hour)
                  <span>
                    <a class="reset"
                      href="javascript:timeChart.filterAll();dc.redrawAll();"
                      style="display: none;">
                      reset
                    </a>
                  </span>
          	  </h4>
              </div>
            </div>

            <div class='row'>
              <div class='span4' id='dc-dayweek-chart'>
                <h4>
                  In which day did we have the most incidents?
                  <span>
                    <a class="reset"
                      href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();"
                      style="display: none;">
                      reset
                    </a>
                  </span>
                </h4>
                  <div class="clearfix"></div>
              </div>


              <div class='span4' id='dc-island-chart'>
          	  <h4>
          		What proportion of incidents resulted in arrests?
                  <span>
                    <a class="reset"
                      href="javascript:islandChart.filterAll();dc.redrawAll();"
                      style="display: none;">
                      reset
                    </a>
                  </span>
                </h4>
              </div>   
              <div class='span4' id='blank2'>
          	  <!-- <h4>Do you have another question</h4> -->
              </div> 
            </div>

            <div class='row'>
          	<div class='span12'>
                <table class='table table-hover' id='dc-table-graph'>
                  <thead>
                    <tr class='header'>
                      <th>Date and Time</th>
                      <th>Lat</th>
                      <th>Long</th>
                      <th>Arrest Status</th>  
                      <th>Google Map</th>
                      <th>OSM Map</th>
                    </tr>
                  </thead>
                </table>
          	</div>
            </div>
          </div>

<script type="text/javascript">


//create a function to print out the output of dimensions and sums
function print_filter(filter){
  var f=eval(filter);
  if (typeof(f.length) != "undefined") {}else{}
  if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
  if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
  console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
} 




// Create the dc.js chart objects & link to div
var dataTable = dc.dataTable("#dc-table-graph");
var magnitudeChart = dc.barChart("#dc-magnitude-chart");
var depthChart = dc.barChart("#dc-depth-chart");
var dayOfWeekChart = dc.rowChart("#dc-dayweek-chart");
var islandChart = dc.pieChart("#dc-island-chart");
var timeChart = dc.lineChart("#dc-time-chart");


d3.csv("./data/Crimes_01_2015_to_present.csv", function (data) {

var dtgFormat = d3.time.format("%m/%d/%Y %H:%M:%S %p");

var numberFormat = d3.format(",f");

data.forEach(function(d) {
  
  d.dtg = dtgFormat.parse(d.Date)
  // d.Date  = d.Date.substr(0,10) // month, day and year
  d.Hour  = d.Date.substr(11,5); //hour
  d.day = d3.time.day(d.dtg).getDay()
  d.lat   = +d.latitude;
  d.lng = +d.longitude;
  d.Ward = +d.Ward;

  });

// TODO clean up this part
// tooltips for row chart
var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function (d) { return "<span style='color: #f0027f'>" +  d.key.split('.')[1] + "</span> : "  + numberFormat(d.value); });

// tooltips for pie chart
var pieTip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function (d) { return "<span style='color: #f0027f'>" +  d.data.key + "</span> : " + numberFormat(d.value)});

// tooltips for bar chart
var barTip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function (d) { return "<span style='color: #f0027f'>" + d.data.key.split('.')[1] + "</span> : " + numberFormat(d.y);});

// set colors to red <--> purple
var moreColors = ["#fde0dd","#fa9fb5","#e7e1ef","#d4b9da","#c994c7","#fcc5c0","#df65b0","#e7298a","#ce1256", "#f768a1","#dd3497","#e78ac3","#f1b6da","#c51b7d"];



var facts = crossfilter(data);
var all = facts.groupAll();

//time dimension

var timeDimension = facts.dimension(function(d){
  return d.dtg;
});

// time chart
var volumeByHour = facts.dimension(function(d) {
  return d3.time.hour(d.dtg);
});
var volumeByHourGroup = volumeByHour.group()
  .reduceCount(function(d) { return d.dtg; });


var dayOfWeek = facts.dimension(function (d) {
    var day = d.dtg.getDay();
    var name = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return day + '.' + name[day];
});

var dayOfWeekGroup = dayOfWeek.group();


// Pie Chart
var Arrests = facts.dimension(function (d) {
  if (d.Arrest === true)
    return "True";
  else
    return "False";

  });


// for Arrests
var ArrestValue = facts.dimension(function (d) {
  return d.Arrest;       // add the Arrest dimension
});

var ArrestValueGroupCount = ArrestValue.group()
  .reduceCount(function(d) { return d.Arrest; }) // counts 



// for Ward
var WardValue = facts.dimension(function (d) {
  return d.Ward;
});
var WardValueGroup = WardValue.group();


var WardGroupCount = WardValue.group()
  .reduceCount(function(d) { return d.Ward; }) // counts 


  // count all the facts
dc.dataCount(".dc-data-count")
  .dimension(facts)
  .group(all);
    
  // Magnitide of Arrests: Bar Graph Counted
magnitudeChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 40, left: 40})
    .dimension(volumeByHour)
    .group(volumeByHourGroup)
  .transitionDuration(500)
    .centerBar(true)  
  .gap(65)  // 65 = norm
//    .filter([3, 5])
  .x(d3.time.scale().domain(d3.extent(data, function(d) { return d.dtg; })))
  .elasticY(true)
  .xAxis().tickFormat();  

  // Ward Incident bar graph
  depthChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(WardValue)
    .group(WardValueGroup)
  .transitionDuration(500)
    .centerBar(true) 
  .colors(moreColors) 
  .gap(1)  
    .x(d3.scale.linear().domain([0, 51]))
  .elasticY(true)
  .xAxis().tickFormat(function(v) {return v;});

  // time graph
  timeChart.width(960)
    .height(150)
    .transitionDuration(500)
//    .mouseZoomable(true)
    .margins({top: 10, right: 10, bottom: 60, left: 40})
    .dimension(volumeByHour)
    .group(volumeByHourGroup)
//    .brushOn(false)     // added for title
    .title(function(d){
      return dtgFormat(d.data.key)
      + "\nNumber of Events: " + d.data.value;
      })
  .elasticY(true)
    .x(d3.time.scale().domain(d3.extent(data, function(d) { return d.dtg; })))
    .xAxis();

// row chart day of week
dayOfWeekChart.width(300)
  .height(220)
  .margins({top: 5, left: 10, right: 10, bottom: 20})
  .group(dayOfWeekGroup)
  .gap(10)
  .dimension(dayOfWeek)
  .colors(moreColors)
  // .colors(d3.scale.category10())
  .label(function (d){
     return d.key.split('.')[1];
  })
  .title(function(d){return d.value;})
  .elasticX(true)
  .xAxis().ticks(4);

// islands pie chart
islandChart.width(250)
  .height(220)
  .radius(100)
  .innerRadius(30)
  .dimension(ArrestValue)
  .title(function(d){return d.value;})
  .on('mouseover', tip.show)
  .on('mouseout',  tip.hide)
  .group(ArrestValueGroupCount);

// Table of crime data
dataTable.width(960).height(800)
  .dimension(timeDimension)
.group(function(d) { return "Table"
 })
.size(10)
  .columns([
    function(d) { return d.dtg; },
    function(d) { return d.Latitude; },
    function(d) { return d.Longitude; },
    function(d) { return d.Arrest; },
    // function(d) { return d.Ward; },
  function(d) { return '<a href=\"http://maps.google.com/maps?z=12&t=m&q=loc:' + d.Latitude + '+' + d.Longitude+"\" target=\"_blank\">Google Map</a>"},
  function(d) { return '<a href=\"http://www.openstreetmap.org/?mlat=' + d.Latitude + '&mlon=' + d.Longitude +'&zoom=12'+ "\" target=\"_blank\"> OSM Map</a>"}
  ])
  .sortBy(function(d){ return d.dtg; })
  .order(d3.ascending);

  // Render the Charts
 dc.renderAll();

  d3.selectAll("g.x text")
      .attr("class", "title")
      .style("text-anchor", "end") 
      .attr("transform", "translate(-10,0)rotate(315)");

  d3.selectAll("g.row").call(tip);
  d3.selectAll("g.row").on('mouseover', tip.show)
      .on('mouseout', tip.hide);

  d3.selectAll(".pie-slice").call(pieTip);
  d3.selectAll(".pie-slice").on('mouseover', pieTip.show)
      .on('mouseout', pieTip.hide);

  d3.selectAll(".bar").call(barTip);
  d3.selectAll(".bar").on('mouseover', barTip.show)
      .on('mouseout', barTip.hide);  

  
});
  
</script>

</body>
</html>